---
title: "Brain Cancer by gender"
output: html_document
date: "2024-03-20"
---

All explanations of codes can be found in the BI453 - Brain Cancer.Rmd. The code is the same however, the matrix 'exprs' is split into male and female samples. 

The only measure of accuracy used in to investigate the difference in clustering between males and females is purity. In addition noise, r, is between 0 and 0.1 in increments of 0.01.

```{r}
Corresdata <- read.delim("BrainCancerLabels.txt", header = TRUE, sep = "\t", as.is = TRUE)
Corresdatalabels <- Corresdata$IDH.1p19q.Subtype

groundtruths <- ifelse(Corresdatalabels == 'IDHmut-non-codel', 1, 
                     ifelse(Corresdatalabels == 'IDHmut-codel', 2, NA))
malegroundtruths <- ifelse((CorresdataMale$IDH.1p19q.Subtype) == 'IDHmut-non-codel', 1, 
                           ifelse((CorresdataMale$IDH.1p19q.Subtype) == 'IDHmut-codel', 2, NA))
femalegroundtruths <- ifelse((CorresdataFemale$IDH.1p19q.Subtype) == 'IDHmut-non-codel', 1, 
                           ifelse((CorresdataFemale$IDH.1p19q.Subtype) == 'IDHmut-codel', 2, NA))

unify_labels <- function(predictcluster, T) {
  match(predictcluster, unique(predictcluster))
}
```

```{r}
CorresdataMale <- Corresdata[Corresdata$gender == "MALE" & !is.na(Corresdata$gender), ]
CorresdataFemale <- Corresdata[Corresdata$gender == "FEMALE" & !is.na(Corresdata$gender), ]
exprs_male <- exprs[, colnames(exprs) %in% CorresdataMale$Tumor]
exprs_female <- exprs[, colnames(exprs) %in% CorresdataFemale$Tumor]
```

```{r}
maxmale <- max(exprs_male)
matrix_listmale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  matrix_listmale[[as.character(r)]] <- list()
  for (x in 1:100) {
    new_matrixmale <- (exprs_male) + r * (matrix(runif(1000 * 128), nrow = 1000, ncol = 128) * maxmale)
    matrix_listmale[[as.character(r)]][[as.character(x)]] <- new_matrixmale
  }
}

maxfemale <- max(exprs_female)
matrix_listfemale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  matrix_listfemale[[as.character(r)]] <- list()
  for (x in 1:100) {
    new_matrixfemale <- (exprs_female) + r * (matrix(runif(1000 * 94), nrow = 1000, ncol = 94) * maxfemale)
    matrix_listfemale[[as.character(r)]][[as.character(x)]] <- new_matrixfemale
  }
}

nmf_resultsmale <- list()
nmf_resultsfemale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  nmf_resultsmale[[as.character(r)]] <- list()
  nmf_resultsfemale[[as.character(r)]] <- list()
  for (x in 1:100) {
  current_matrixmale <- matrix_listmale[[as.character(r)]][[as.character(x)]]
  current_matrixfemale <- matrix_listfemale[[as.character(r)]][[as.character(x)]]
  nmf_resultmale <- nmf(current_matrixmale, 2, nrun = 2, seed = "random")
  nmf_resultfemale <- nmf(current_matrixfemale, 2, nrun = 2, seed = "random")
  nmf_resultsmale[[as.character(r)]][[as.character(x)]] <- nmf_resultmale
  nmf_resultsfemale[[as.character(r)]][[as.character(x)]] <- nmf_resultfemale
  }
}

predictionsmale <- list()
predictionsfemale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  predictionsmale[[as.character(r)]] <- list()
  predictionsfemale[[as.character(r)]] <- list()
  for (x in 1:100) {
  cluster_predictionsmale <- (nmf_resultsmale[[as.character(r)]])[[x]]
  cluster_predictionsfemale <- (nmf_resultsfemale[[as.character(r)]])[[x]]
  clusterpredictmale <- unify_labels((predict(cluster_predictionsmale)), malegroundtruths)
  clusterpredictfemale <- unify_labels((predict(cluster_predictionsfemale)), femalegroundtruths)
  predictionsmale[[as.character(r)]][[as.character(x)]] <- clusterpredictmale
  predictionsfemale[[as.character(r)]][[as.character(x)]] <- clusterpredictfemale
  }
}
```

Purity comparing male and female
```{r}
puritylistmale <- list()
puritylistfemale <- list()
for (r in seq(0,0.1, by = 0.01)) {
  puritylistmale[[as.character(r)]] <- list()
  puritylistfemale[[as.character(r)]] <- list()
  for (x in 1:100) {
  purity_resultsmale <- predictionsmale[[as.character(r)]][[x]]
  purity_resultsfemale <- predictionsfemale[[as.character(r)]][[x]]
  puritymeasuremale <- purity(malegroundtruths, purity_resultsmale)
  puritymeasurefemale <- purity(femalegroundtruths, purity_resultsfemale)
  puritylistmale[[as.character(r)]][[as.character(x)]] <- puritymeasuremale
  puritylistfemale[[as.character(r)]][[as.character(x)]] <- puritymeasurefemale
  }
}

purityaveragemale <- list()
purityaveragefemale <- list()
sempuritymale <- list()
sempurityfemale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  puritiesmale <- sapply(1:100, function(x) puritylistmale[[as.character(r)]][[as.character(x)]]$pur)
  puritiesfemale <- sapply(1:100, function(x) puritylistfemale[[as.character(r)]][[as.character(x)]]$pur)
  purityaveragemale[[as.character(r)]] <- mean(unlist(puritiesmale))
  purityaveragefemale[[as.character(r)]] <- mean(unlist(puritiesfemale))
  sempuritymale[[as.character(r)]] <- std.error(unlist(puritiesmale))
  sempurityfemale[[as.character(r)]] <- std.error(unlist(puritiesfemale))
}

Accuracypuritymalefem_table <- data.frame(
  r = seq(0, 0.1, by = 0.01),
  Averagepuritymale = unlist(purityaveragemale),
  Averagepurityfemale = unlist(purityaveragefemale)
)

Accuracypuritymalefem_table
```

Post-Processing Method - Normalisation
```{r}
W_matricesmale <- list()
W2_matricesmale <- list()
for(r in seq(0, 0.1, by = 0.01)) {
  W_matricesmale[[as.character(r)]] <- list()
  W2_matricesmale[[as.character(r)]] <- list()
  for (x in 1:100) {
  NMFinputmale <- (nmf_resultsmale[[as.character(r)]])[[x]]
  Wmatrixgenmale <- basis(NMFinputmale)
  W_matricesmale[[as.character(r)]][[as.character(x)]] <- Wmatrixgenmale
  W2_matricesmale[[as.character(r)]][[as.character(x)]] <- Wmatrixgenmale
  }
}

H_matricesmale <- list()
H2_matricesmale <- list()
for(r in seq(0, 0.1, by = 0.01)) {
  H_matricesmale[[as.character(r)]] <- list()
  H2_matricesmale[[as.character(r)]] <- list()
  for (x in 1:100) {
  NMFinputmale <- (nmf_resultsmale[[as.character(r)]])[[x]]
  Hmatrixgenmale <- coef(NMFinputmale)
  H_matricesmale[[as.character(r)]][[as.character(x)]] <- Hmatrixgenmale
  H2_matricesmale[[as.character(r)]][[as.character(x)]] <- Hmatrixgenmale
  }
}

W_matricesfemale <- list()
W2_matricesfemale <- list()
for(r in seq(0, 0.1, by = 0.01)) {
  W_matricesfemale[[as.character(r)]] <- list()
  W2_matricesfemale[[as.character(r)]] <- list()
  for (x in 1:100) {
  NMFinputfemale <- (nmf_resultsfemale[[as.character(r)]])[[x]]
  Wmatrixgenfemale <- basis(NMFinputfemale)
  W_matricesfemale[[as.character(r)]][[as.character(x)]] <- Wmatrixgenfemale
  W2_matricesfemale[[as.character(r)]][[as.character(x)]] <- Wmatrixgenfemale
  }
}

H_matricesfemale <- list()
H2_matricesfemale <- list()
for(r in seq(0, 0.1, by = 0.01)) {
  H_matricesfemale[[as.character(r)]] <- list()
  H2_matricesfemale[[as.character(r)]] <- list()
  for (x in 1:100) {
  NMFinputfemale <- (nmf_resultsfemale[[as.character(r)]])[[x]]
  Hmatrixgenfemale <- coef(NMFinputfemale)
  H_matricesfemale[[as.character(r)]][[as.character(x)]] <- Hmatrixgenfemale
  H2_matricesfemale[[as.character(r)]][[as.character(x)]] <- Hmatrixgenfemale
  }
}

for (r in seq(0, 0.1, by = 0.01)) {
  for (x in 1:100) {
  max_valuesmale <- apply((W2_matricesmale[[as.character(r)]][[as.character(x)]]), 2, max)
  W2_matricesmale[[as.character(r)]][[as.character(x)]] <- (W2_matricesmale[[as.character(r)]][[as.character(x)]]) / max_valuesmale
  H2_matricesmale[[as.character(r)]][[as.character(x)]] <- (H2_matricesmale[[as.character(r)]][[as.character(x)]]) * max_valuesmale
  }
}

for (r in seq(0, 0.1, by = 0.01)) {
  for (x in 1:100) {
  max_valuesfemale <- apply((W2_matricesfemale[[as.character(r)]][[as.character(x)]]), 2, max)
  W2_matricesfemale[[as.character(r)]][[as.character(x)]] <- (W2_matricesfemale[[as.character(r)]][[as.character(x)]]) / max_valuesfemale
  H2_matricesfemale[[as.character(r)]][[as.character(x)]] <- (H2_matricesfemale[[as.character(r)]][[as.character(x)]]) * max_valuesfemale
  }
}

predicted_clustersmale <- list()
H2_clustersmale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  for (x in 1:100) {
    H_matrixmale <- H2_matricesmale[[as.character(r)]][[as.character(x)]]
    cluster_assignmentsmale <- apply(H_matrixmale, 2, which.max)
    predicted_clustersmale[[as.character(r)]][[as.character(x)]] <- cluster_assignmentsmale
    unifyingclustersmale <- unify_labels((predicted_clustersmale[[as.character(r)]][[as.character(x)]]), malegroundtruths)
    H2_clustersmale[[as.character(r)]][[as.character(x)]] <- unifyingclustersmale
  }
}

predicted_clustersfemale <- list()
H2_clustersfemale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  for (x in 1:100) {
    H_matrixfemale <- H2_matricesfemale[[as.character(r)]][[as.character(x)]]
    cluster_assignmentsfemale <- apply(H_matrixfemale, 2, which.max)
    predicted_clustersfemale[[as.character(r)]][[as.character(x)]] <- cluster_assignmentsfemale
    unifyingclustersfemale <- unify_labels((predicted_clustersfemale[[as.character(r)]][[as.character(x)]]), femalegroundtruths)
    H2_clustersfemale[[as.character(r)]][[as.character(x)]] <- unifyingclustersfemale
  }
}
```

Purity Post-Normalisation
```{r}
puritylist2male <- list()
for (r in seq(0,0.1, by = 0.01)) {
  puritylist2male[[as.character(r)]] <- list()
  for (x in 1:100) {
  purity_results2male <- H2_clustersmale[[as.character(r)]][[as.character(x)]]
  puritymeasure2male <- purity(malegroundtruths, purity_results2male)
  puritylist2male[[as.character(r)]][[as.character(x)]] <- puritymeasure2male
  }
}

purityaverage2male <- list()
sempurity2male <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  purities2male <- sapply(1:100, function(x) puritylist2male[[as.character(r)]][[as.character(x)]]$pur)
  purityaverage2male[[as.character(r)]] <- mean(unlist(purities2male))
  sempurity2male[[as.character(r)]] <- std.error(unlist(purities2male))
}

puritylist2female <- list()
for (r in seq(0,0.1, by = 0.01)) {
  puritylist2female[[as.character(r)]] <- list()
  for (x in 1:100) {
  purity_results2female <- H2_clustersfemale[[as.character(r)]][[as.character(x)]]
  puritymeasure2female <- purity(femalegroundtruths, purity_results2female)
  puritylist2female[[as.character(r)]][[as.character(x)]] <- puritymeasure2female
  }
}

purityaverage2female <- list()
sempurity2female <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  purities2female <- sapply(1:100, function(x) puritylist2female[[as.character(r)]][[as.character(x)]]$pur)
  purityaverage2female[[as.character(r)]] <- mean(unlist(purities2female))
  sempurity2female[[as.character(r)]] <- std.error(unlist(purities2female))
}

Accuracypuritymalefem_table2 <- data.frame(
  r = seq(0, 0.1, by = 0.01),
  Averagepuritymale = unlist(purityaverage2male),
  Averagepurityfemale = unlist(purityaverage2female)
)

Accuracypuritymalefem_table2
```

```{r}
library(plotrix)
prepurity_valuesmale <- list()
prepurity_valuesfemale <- list()
postpurity_valuesmale <- list()
postpurity_valuesfemale <- list()
for (r in seq(0, 0.1, by = 0.01)) {
  prepuritymale <- sapply(1:100, function(x) puritylistmale[[as.character(r)]][[as.character(x)]]$pur)
  prepurityfemale <- sapply(1:100, function(x) puritylistfemale[[as.character(r)]][[as.character(x)]]$pur)
  postpuritymale <- sapply(1:100, function(x) puritylist2male[[as.character(r)]][[as.character(x)]]$pur)
  postpurityfemale <- sapply(1:100, function(x) puritylist2female[[as.character(r)]][[as.character(x)]]$pur)
    prepurity_valuesmale[[as.character(r)]] <- unlist(prepuritymale)
    prepurity_valuesfemale[[as.character(r)]] <- unlist(prepurityfemale)
    postpurity_valuesfemale[[as.character(r)]] <- unlist(postpurityfemale)
    postpurity_valuesmale[[as.character(r)]] <- unlist(postpuritymale)
}


SEM1male <- std.error(prepurity_valuesmale[['0']])
SEM2female<- std.error(postpurity_valuesfemale[['0']])

purityttestmale <- t.test((prepurity_valuesmale[['0']]), (postpurity_valuesmale[['0']]), paired = TRUE, alternative = "two.sided")

purityttestmale

purityttestfemale <- t.test((prepurity_valuesfemale[['0']]), (postpurity_valuesfemale[['0']]), paired = TRUE, alternative = "two.sided")

purityttestfemale

t.test((postpurity_values[['0']]), (postpurity_valuesmale[['0']]), paired = TRUE, alternative = "two.sided")

```

```{r}
gendercomparisonpre <- data.frame(
  r = seq(0, 0.1, by = 0.05),
  Averagepurityboth = unlist(purityaverage[1:3]),
  Averagepuritymale = unlist(purityaveragemale[c(1, 6, 11)]),
  Averagepurityfemale = unlist(purityaveragefemale[c(1, 6, 11)]),
  semboth = unlist(sempurity[1:3]),
  sempuritymale = unlist(sempuritymale[c(1, 6, 11)]),
  sempurityfemale = unlist(sempurityfemale[c(1, 6, 11)])
)

gendercomparisonpost <- data.frame(
  r = seq(0, 0.1, by = 0.05),
  Averagepurityboth = unlist(purityaverage2[1:3]),
  Averagepuritymale = unlist(purityaverage2male[c(1, 6, 11)]),
  Averagepurityfemale = unlist(purityaverage2female[c(1, 6, 11)]),
  semboth = unlist(sempurity2[1:3]),
  sempuritymale = unlist(sempurity2male[c(1, 6, 11)]),
  sempurityfemale = unlist(sempurity2female[c(1, 6, 11)])
)

purity_plot <- ggplot(gendercomparisonpre, aes(x = r)) +
  geom_line(aes(y = Averagepurityboth, color = "Both"), size = 1) +
  geom_errorbar(aes(y = Averagepurityboth, ymin = Averagepurityboth - semboth, ymax = Averagepurityboth + semboth), color = "blue", width = 0.01, size = 0.5) +
  geom_line(aes(y = Averagepuritymale, color = "Male"), size = 1) +
  geom_errorbar(aes(y = Averagepuritymale, ymin = Averagepuritymale - sempuritymale, ymax = Averagepuritymale + sempuritymale), color = "green", width = 0.01, size = 0.5) +
  geom_line(aes(y = Averagepurityfemale, color = "Female"), size = 1) +
  geom_errorbar(aes(y = Averagepurityfemale, ymin = Averagepurityfemale - sempurityfemale, ymax = Averagepurityfemale + sempurityfemale), color = "violetred", width = 0.01, size = 0.5) +
  labs(title = "Comparison of NMF, with respect to gender, pre-processing", x = "Noise", y = "Purity") +
  scale_color_manual(name = NULL, values = c("Both" = "blue", "Male" = "green", "Female" = "violetred")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
purity_plot + theme(legend.position = "bottom")

purity_plotpost <- ggplot(gendercomparisonpost, aes(x = r)) +
  geom_line(aes(y = Averagepurityboth, color = "Both"), size = 1) +
  geom_errorbar(aes(y = Averagepurityboth, ymin = Averagepurityboth - semboth, ymax = Averagepurityboth + semboth), color = "blue", width = 0.01, size = 0.5) +
  geom_line(aes(y = Averagepuritymale, color = "Male"), size = 1) +
  geom_errorbar(aes(y = Averagepuritymale, ymin = Averagepuritymale - sempuritymale, ymax = Averagepuritymale + sempuritymale), color = "green", width = 0.01, size = 0.5) +
  geom_line(aes(y = Averagepurityfemale, color = "Female"), size = 1) +
  geom_errorbar(aes(y = Averagepurityfemale, ymin = Averagepurityfemale - sempurityfemale, ymax = Averagepurityfemale + sempurityfemale), color = "violetred", width = 0.01, size = 0.5) +
  labs(title = "Comparison of NMF, with respect to gender, post-processing", x = "Noise", y = "Purity") +
  scale_color_manual(name = NULL, values = c("Both" = "blue", "Male" = "green", "Female" = "violetred")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
purity_plotpost + theme(legend.position = "bottom")


```

